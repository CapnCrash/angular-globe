!function(){"use strict";function t(){function t(t,n){x=t,$=x.raisedLand(),m=x.size()||n[0].clientWidth||I,d3.select(window).on("resize",u.bind(null,n)),b=d3.geo.orthographic().translate([m/2,m/2]).center([0,0]).precision(.5),f=d3.select(n[0]).append("svg").attr({"class":"m2s-globe",width:m,height:m}),h=d3.geo.path().projection(b),b.scale(m/2.3).clipAngle(90),y=f.append("g").attr("class","m2s-globe-land-group"),A=y.append("path").datum({type:"Sphere"}).attr("class","m2s-globe-water").attr("fill",j).attr("d",h),x.graticule()!==!1&&(k=y.selectAll("path.m2s-globe-land-group").data(d3.geo.graticule().lines()).enter().append("path").attr({fill:"none",stroke:E,"stroke-opacity":.5,"class":"m2s-globe-graticule"})),x.$watch("mapData",e),x.$watch("points",a,!0),x.$watch("draggable",o),x.$watch("sensitivity",o),x.$watch("clickable",s),x.$watch("rotate",p),x.$watch("rotateAngle",d)}function e(t){if(!t&&mapData){var e=x.mapType||"land";t=topojson.feature(mapData,mapData.objects[e])}t?(d3.selectAll(".m2s-globe-land").remove(),$!==!1&&(w=y.append("path").datum(t).attr("class","m2s-globe-land m2s-globe-shadow").style({"-webkit-filter":"blur(6px)",filter:"blur(6px)",opacity:.4}),D=y.append("path").datum(t).attr("fill",F).attr("class","m2s-globe-land m2s-globe-land-bottom")),S=y.append("path").datum(t).attr("fill",E).attr("class","m2s-globe-land m2s-globe-land-top"),i()):d3.selectAll(".m2s-globe-land").remove()}function a(t){t=t||[];var e=[];angular.forEach(t,function(t){t.values&&t.values.length&&(e=e.concat(t.values.map(r)))}),v=f.selectAll(".m2s-globe-points").data(e),v.enter().append("path").attr({opacity:function(t,e){return l("enter",t,e)>0?0:1}}).transition().ease(x.enterAnimEase()||C).delay(function(t,e){return l("enter",t,e)||0}).attr("opacity",1),v.attr({fill:n(x.pointFill,L),stroke:n(x.pointStroke,z),"stroke-width":n(x.pointStrokeWidth,W)}).attr("id",function(t){return t.id}).attr("class",function(t){return n(x.pointClass)(t)+" m2s-globe-points"}),s(x.clickable),v.exit().transition().ease(x.exitAnimEase()||C).delay(function(t,e){return l("exit",t,e)||0}).attr("opacity",0).remove(),i()}function n(t,e){return function(a){return t({d:a.properties})||e}}function i(){b.scale(m/2.3).clipAngle(90),x.graticule()!==!1&&k.attr("d",h),$!==!1&&(w&&w.attr("d",h),b.scale(m/2.2).clipAngle(106.3),D&&D.attr("d",h),b.scale(m/2.2).clipAngle(90)),S&&S.attr("d",h),f.selectAll(".m2s-globe-points").attr("d",function(t){return h.pointRadius(n(x.pointRadius,R)(t))(t)})}function r(t){return{type:"Feature",id:n(x.pointId,g())({properties:t}),properties:t,geometry:{type:"Point",coordinates:[n(x.pointLng)({properties:t}),n(x.pointLat)({properties:t})]}}}function o(){var t=x.draggable(),e=x.sensitivity()||.25;t?y.call(d3.behavior.drag().origin(function(){var t=b.rotate();return{x:t[0]/e,y:-t[1]/e}}).on("drag",function(){var t=b.rotate();b.rotate([d3.event.x*e,-d3.event.y*e,t[2]]),i()})):y.on("dragstart",null).on("drag",null).on("dragend",null)}function l(t,e,a){return x[t+"AnimDuration"]({d:e,i:a})||0}function s(t){t()===!1?(v.style("cursor","normal"),v.on("click",null)):(v.style("cursor","pointer"),v.on("click",c))}function c(t){var e=[n(x.pointLng)(t),n(x.pointLat)(t)],a=d3.select("#"+t.id);x.$apply(function(){x.pointClick({d:t.properties,c:b(e),el:a})})}function p(){x.rotate()&&d3.timer(function(){var t=x.rotateSpeed()||0===x.rotateSpeed()?x.rotateSpeed():1;return b.rotate([t/100*(Date.now()-M),-15]),i(),!x.rotate()})}function d(t){t=t(),t&&2===t.length&&b.rotate([t[0],t[1]])}function u(t){x.size()||(m=t[0].clientWidth||I,f.attr({width:m,height:m}),b.translate([m/2,m/2]).scale(m/2.3).clipAngle(90),A.attr("d",h),i())}function g(){function t(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return"point-"+t()}var m,f,h,b,v,y,A,k,w,D,S,x,$,L="#8D6E63",E="#dadac4",F="#737368",j="#FFF",z="#000",C="cubic",W=0,R=5,I=400,M=new Date;return{link:t,restrict:"EA",scope:{points:"=",mapData:"=",mapType:"@",size:"&",pointStroke:"&",pointFill:"&",pointClass:"&",pointId:"&",pointLat:"&",pointLng:"&",pointRadius:"&",pointStrokeWidth:"&",graticule:"&",draggable:"&",sensitivity:"&",clickable:"&",pointClick:"&",raisedLand:"&",rotate:"&",rotateSpeed:"&",rotateAngle:"&",enterAnimDuration:"&",exitAnimDuration:"&",enterAnimEase:"&",exitAnimEase:"&"}}}angular.module("madvas.angular-globe",[]).directive("m2sGlobe",t),t.$inject=[]}();